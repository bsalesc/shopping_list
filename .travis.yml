language: node_js
node_js:
  - '8'

services:
  - docker

addons:
  apt:
    sources:
      - google-chrome
    packages:
      - google-chrome-stable

cache:
  yarn: true
  directories:
    - node_modules
    - dist

jobs:
  include:
    - stage: build and test APP
      script:
        - cd ./app
        - yarn
        - yarn test:headless
        - yarn deploy
    - stage: build and test RESTapi
      script:
        - cd ./api
        - yarn
        - yarn test
    - stage: publish on azure
      script:
        - docker-compose build;
        - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD" $REGISTRY;
        - docker-compose push;

      # env:
      #   - PROJECT='app'
      #   - PROJECT='api'

      # before_install:
      #   - if [ $PROJECT == 'api' ]; then cd ./api; fi;

      # cache:
      #   yarn: true
      #   directories:
      #     - node_modules

      # install:
      #   - yarn

      # script:
      #   - if [ $PROJECT == 'api' ];
      #     then yarn test;
      #     else yarn test:headless;
      #     fi;
      #   - yarn deploy;

# after_sucess:
#   - docker-compose build;
#   - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD" $REGISTRY;
#   - docker-compose push;
